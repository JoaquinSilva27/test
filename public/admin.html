<!-- public/admin.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Administración</title>
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <script>
        // Función autoejecutable para verificar si el usuario es administrador
        (async () => {
          try {
            // Solicitud al servidor para verificar la sesión y el rol
            const response = await fetch("/auth/verify-session");
            const data = await response.json();
    
            if (!data.success || data.user.rol !== "admin") {
                alert("Acceso Denegado")
                window.location.href = "/user.html";
            }
          } catch (error) {
            alert(error)
            console.error("Error verificando la sesión:", error);
            // En caso de error, redirige al login
            window.location.href = "/login.html";
          }
        })();
      </script>
      <script>
        // Función para verificar el estado de la sesión cada minuto
        setInterval(async () => {
          try {
            const response = await fetch("/auth/check-session");
            const data = await response.json();
      
            if (!data.success) {
              // Si la sesión ha expirado, muestra una alerta y redirige al login
              alert(data.message);
              window.location.href = "/login.html";
            }
          } catch (error) {
            console.error("Error verificando la sesión:", error);
          }
        }, 600000); // 60000 ms = 1 minuto
      </script>
</head>
<body>
  <!-- Sidebar Container -->
  <div id="sidebar-container" class="sidebar">
    <header class="sidebar-header">MENU</header>
    <nav>
      <a href="#" onclick="showMsj()">Inicio</a>
      <a href="#" onclick="showAdminRegistros()">Administración de Registros</a>
      <a href="#">Gestores</a>
      <a href="#" onclick="showReportes()">Reportes</a>
    </nav>
  </div>

  <!-- Main Content Container -->
  <div id="content-container" class="main-content">
    <header class="main-header">
        <div class="logo-menu">
            <span class="icon-menu" onclick="toggleSidebar()">☰</span>
            <h2 class="logo">Riego Maule Sur</h2>
        </div>
        <nav class="navegacion">
            <a href="index.html">Inicio</a>
            <button class="btnLogin-popup" onclick="window.location.href='login.html';">Cerrar Sesión</button>
        </nav>
    </header>

    <!-- Contenido principal (mensaje de bienvenida) -->
    <div class="contenedor" id="contenedor" style="display: block;">
        <h2 class="mensaje-inicio" id="mensaje-inicio">¡Bienvenido/a!</h2>
    </div>

    <!-- Contenedor de Administración de Registros (inicialmente oculto) -->
    <div id="admin-registros-container" class="container-crud" style="display: none;">
        <div class="contenedor-form-crud">
          <h2>Administración de Registros</h2>
        </div>
        <div id="admin-options">
            <h3>¿Qué acción deseas realizar?</h3>
            <button class="btn" onclick="selectAction('Agregar')">Agregar</button>
            <button class="btn" onclick="selectAction('Consultar')">Consultar</button>
            <button class="btn" onclick="selectAction('Modificar')">Modificar</button>
            <button class="btn" onclick="selectAction('Eliminar')">Eliminar</button>
        </div>
      <div id="form-container"></div>
    </div>


    <!-- Seccion de agregar -->
    <section id="second-section" style="display: none;">
      <div id="second-form-container">
          <!-- Título estático -->
          <div class="fixed-header">
            <h3 id="second-form-title"></h3>
          </div>
          <!-- Contenido desplazable -->
          <div class="scrollable-content">
            <div id="fields-container"></div>
          </div>
          <!-- Botón de enviar estático -->
          <div class="fixed-footer">
            <button class="btn-guardar" onclick="agregarEntidad()">Enviar</button>
          </div>
      </div>
    </section>


    <!-- Sección de Consultas -->
    <section id="consultar-section" style="display: none;">
      <div id="consultar-container">
        <!-- Contenedor de búsqueda -->
        <div class="consultar-busqueda">
          <h3>Consultar</h3>
          <input type="text" id="consulta-input" placeholder="RUT, Nombre o Clave Primaria" required>
          <button class="btn-consultar" onclick="consultarEntidad()">Consultar</button>
        </div>

        <!-- Contenedor de resultados -->
        <div class="resultado-consulta">
          <div class="header-resultados">
            <h3>Datos de la Entidad Seleccionada</h3>
          </div>
          <div class="campos-resultado">
            <div class="campo">
              <label>Campo 1</label>
              <input type="text" id="campo1" disabled />
            </div>
            <div class="campo">
              <label>Campo 2</label>
              <input type="text" id="campo2" disabled />
            </div>
            <div class="campo">
              <label>Campo 3</label>
              <input type="text" id="campo3" disabled />
            </div>
            <div class="campo">
              <label>Campo 4</label>
              <input type="text" id="campo4" disabled />
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Sección de Modificar -->
    <section id="modificar-section" style="display: none;">
      <div class="modificar-busqueda">
        <h3>Modificar Registro</h3>
        <input type="text" id="modificar-input" placeholder="Ingrese el criterio de búsqueda">
        <button class="btn-guardar" id="btn-modificar" onclick="buscarParaModificar()">Buscar</button>
      </div>

      <div class="resultado-modificar">
        <h3>Editar Datos de la Entidad</h3>
        <div class="campos-modificar">
        </div>
        <button class="btn-guardar" id="btn-guardar-modificar" onclick="guardarModificaciones()">Guardar Cambios</button>
      </div>
    </section>

    <!-- Sección de Eliminar -->
    <section id="eliminar-section" style="display: none;">
      <div class="eliminar-busqueda">
        <h3>Eliminar Registro</h3>
        <input type="text" id="eliminar-input" placeholder="Ingrese la clave primaria (RUT, nombre, etc.)">
        <button class="btn-guardar" id="btn-eliminar" onclick="confirmarEliminar()">Eliminar</button>
      </div>
    </section>


    <!-- Sección de Reportes -->
    <section id="reportes-section" style="display: none;">
      <div class="reportes-container">
        <h2>Generación de Reportes</h2>
        <select id="reporte-select" onchange="mostrarOpcionesReporte()">
          <option value="">Seleccione un tipo de reporte</option>
          <option value="regantes-por-canal">Regantes por Canal</option>
          <option value="regantes-y-predios">Regantes y sus Predios</option>
          <option value="ingresos-por-fecha">Informe de Ingresos (Rango de Fechas)</option>
          <option value="proyectos-activos-terminados">Proyectos Activos/Terminados</option>
          <option value="deudas-por-canal">Deudas por Canal</option>
        </select>

        <!-- Opciones adicionales dinámicas -->
        <div id="opciones-reporte" style="margin-top: 20px;"></div>

        <!-- Botón para generar el reporte -->
        <button class="btn-guardar" onclick="generarReporte()">Generar Reporte</button>

        <!-- Contenedor para mostrar los resultados del reporte -->
        <div id="resultado-reporte" style="margin-top: 30px;">
          <h3>Resultados del Reporte</h3>
          <div id="reporte-resultados">
            <!-- Aquí se mostrarán los datos generados dinámicamente -->
          </div>
        </div>
      </div>
    </section>

  </div>
  <script src="js/admin.js"></script>
  <script src="js/sidebar.js"></script>
</body>
</html>
